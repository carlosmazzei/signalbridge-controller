# Command Protocol Reference

This document describes the firmware command protocol used by the USB CDC
interface, including packet framing, payload layouts, and practical examples.
It reflects the behavior implemented in the current firmware sources.

## Transport and framing

- **Transport:** USB CDC (TinyUSB)
- **Framing:** COBS (Consistent Overhead Byte Stuffing)
- **Packet delimiter:** `0x00` (COBS packet marker)
- **Checksum:** XOR of all header + payload bytes (1 byte)

### Decoded packet layout (before COBS encoding)

```
Byte 0  : ID high bits (upper 8 bits of the 11-bit board ID)
Byte 1  : ID low bits (upper 3 bits) + command (lower 5 bits)
Byte 2  : Payload length (N)
Byte 3..(3+N-1) : Payload bytes
Byte 3+N        : XOR checksum (bytes 0..(2+N))
```

**Board ID packing (11-bit ID):**

```
rxID = (byte0 << 3) | ((byte1 & 0xE0) >> 5)
cmd  = byte1 & 0x1F
```

The firmware expects `rxID` to match `BOARD_ID` (configured as `0x01`).

**COBS framing:** The decoded bytes above are COBS-encoded and terminated with
`0x00` on the wire.

## Command IDs

Defined in `include/commands.h`:

| Command | ID (hex) | Notes |
|---|---:|---|
| `PC_PWM_CMD` | `0x01` | PWM brightness update |
| `PC_LEDOUT_CMD` | `0x02` | LED output update |
| `PC_AD_CMD` | `0x03` | ADC event (device → host) |
| `PC_KEY_CMD` | `0x04` | Keypad event (device → host) |
| `PC_DISPLAY_CMD` | `0x05` | 7-seg display update (enum only) |
| `PC_ROTARY_CMD` | `0x06` | Rotary encoder event (device → host) |
| `PC_TRIM_CMD` | `0x07` | Trim wheel event (enum only) |
| `PC_OPTO_CMD` | `0x08` | Opto input event (enum only) |
| `PC_RELE_CMD` | `0x09` | Relay control (enum only) |
| `PC_DPYCTL_CMD` | `0x0A` | Display control (handled) |
| `PC_TCAS_CMD` | `0x0B` | TCAS update (enum only) |
| `PC_FCU_CMD` | `0x0C` | FCU update (enum only) |
| `PC_SETVALUE_CMD` | `0x0D` | Generic set-value (enum only) |
| `PC_DEBUG_CMD` | `0x10` | Debug data (enum only) |
| `PC_DEBUG_CTL1_CMD` | `0x11` | Debug control channel 1 (enum only) |
| `PC_DEBUG_CTL2_CMD` | `0x12` | Debug control channel 2 (enum only) |
| `PC_DEBUG_CTL3_CMD` | `0x13` | Debug control channel 3 (enum only) |
| `PC_ECHO_CMD` | `0x14` | Echo request (handled) |
| `PC_IDTABLE_CMD` | `0x15` | Identification table (enum only) |
| `PC_IO_ERROR_STATUS_CMD` | `0x16` | I/O error summary (enum only) |
| `PC_ERROR_STATUS_CMD` | `0x17` | Error status query (handled) |
| `PC_TASK_STATUS_CMD` | `0x18` | FreeRTOS task status request (handled) |
| `PC_USBSTATUS_CMD` | `0x19` | USB link status request (enum only) |
| `PC_ID_CONFIRM_NODE` | `0x1A` | Node confirmation (enum only) |
| `PC_ID_CONFIRM` | `0x1B` | Confirmation response (enum only) |
| `PC_ID_REQUEST` | `0x1C` | Identification request (enum only) |
| `PC_CONFIG_CMD` | `0x1D` | Configuration update (enum only) |
| `PC_ENUMERATE_CMD` | `0x1E` | Enumeration trigger (enum only) |

### Implemented inbound handlers (host → device)

The current firmware handles these commands:

- `PC_PWM_CMD`
- `PC_LEDOUT_CMD`
- `PC_DPYCTL_CMD`
- `PC_ECHO_CMD`
- `PC_ERROR_STATUS_CMD`
- `PC_TASK_STATUS_CMD`

### Implemented outbound events (device → host)

Generated by the input subsystem:

- `PC_KEY_CMD`
- `PC_AD_CMD`
- `PC_ROTARY_CMD`

## Payload formats (implemented)

### PWM update (`PC_PWM_CMD`, 0x01)

- **Direction:** Host → Device
- **Length:** 1 byte
- **Payload:**
  - `payload[0]`: duty cycle (`0x00`–`0xFF`)

### LED update (`PC_LEDOUT_CMD`, 0x02)

- **Direction:** Host → Device
- **Length:** 3 bytes
- **Payload:**
  - `payload[0]`: controller ID (1–8)
  - `payload[1]`: LED index
  - `payload[2]`: LED state

### Display control (`PC_DPYCTL_CMD`, 0x0A)

> Note: The **packet header** contains the board ID and command.
> The **first payload byte encodes the controller ID and the display action**.

- **Direction:** Host → Device
- **Length:** 6 bytes for digit updates, 2 bytes for brightness updates
- **Payload (digit update):**
  - `payload[0]`: controller/action byte (`0x20` for controller ID 1)
  - `payload[1]..payload[4]`: packed BCD digits (two digits per byte)
  - `payload[5]`: dot position/flags passed to the driver
- **Payload (brightness update):**
  - `payload[0]`: controller/action byte (`0x21` for controller ID 1)
  - `payload[1]`: brightness value

### Echo (`PC_ECHO_CMD`, 0x14)

- **Direction:** Host → Device (request), Device → Host (response)
- **Length:** any
- **Behavior:** Device returns the same payload.

### Error status (`PC_ERROR_STATUS_CMD`, 0x17)

- **Request length:** 1 byte
- **Request payload:**
  - `payload[0]`: error counter index

- **Response length:** 5 bytes
- **Response payload:**
  - `payload[0]`: index
  - `payload[1..4]`: 32-bit counter value (big-endian)

### Task status (`PC_TASK_STATUS_CMD`, 0x18)

- **Request length:** 1 byte
- **Request payload:**
  - `payload[0]`: task index
    - If `payload[0] > NUM_TASKS`, response is a single byte `0xFF`.

- **Response length:** 13 bytes
- **Response payload:**
  - `payload[0]`: index
  - `payload[1..4]`: runtime counter (big-endian)
  - `payload[5..8]`: runtime percent (big-endian)
  - `payload[9..12]`: high watermark (or minimum free heap for `index == NUM_TASKS`)

### Keypad event (`PC_KEY_CMD`, 0x04)

- **Direction:** Device → Host
- **Length:** 1 byte
- **Payload:**
  - `payload[0] = (column << 4) | (row << 1) | state`
  - `state`: `1` pressed, `0` released

### ADC event (`PC_AD_CMD`, 0x03)

- **Direction:** Device → Host
- **Length:** 3 bytes
- **Payload:**
  - `payload[0]`: channel
  - `payload[1]`: value high byte
  - `payload[2]`: value low byte

### Rotary event (`PC_ROTARY_CMD`, 0x06)

- **Direction:** Device → Host
- **Length:** 2 bytes
- **Payload:**
  - `payload[0]`: `(rotary_index << 4)`
  - `payload[1]`: direction (`1` clockwise, `0` counter-clockwise)

## Example messages (decoded, pre-COBS, no checksum)

Each example below shows the **decoded** message bytes that a test program
would prepare **before** computing the checksum and **before** COBS encoding.
The examples assume `BOARD_ID = 0x01`. Commands that use a controller ID use
`controller_id = 1` in the payload examples.

| Command | Example bytes (hex, no checksum) | Example payload note |
|---|---|---|
| `PC_PWM_CMD` (`0x01`) | `00 21 01 20` | Duty cycle `0x20` |
| `PC_LEDOUT_CMD` (`0x02`) | `00 22 03 01 02 01` | Controller 1, LED index 2, state 1 |
| `PC_AD_CMD` (`0x03`) | `00 23 03 03 0A BC` | Channel 3, value `0x0ABC` |
| `PC_KEY_CMD` (`0x04`) | `00 24 01 11` | Column 1, row 0, pressed |
| `PC_DISPLAY_CMD` (`0x05`) | `00 25 00` | No payload defined (enum only) |
| `PC_ROTARY_CMD` (`0x06`) | `00 26 02 10 01` | Rotary index 1, clockwise |
| `PC_TRIM_CMD` (`0x07`) | `00 27 00` | No payload defined (enum only) |
| `PC_OPTO_CMD` (`0x08`) | `00 28 00` | No payload defined (enum only) |
| `PC_RELE_CMD` (`0x09`) | `00 29 00` | No payload defined (enum only) |
| `PC_DPYCTL_CMD` (`0x0A`) | `00 2A 06 20 12 34 56 78 02` | Controller 1 digit update, digits 1–8, dot flags `0x02` |
| `PC_DPYCTL_CMD` (`0x0A`) | `00 2A 02 21 04` | Controller 1 brightness update, brightness `0x04` |
| `PC_TCAS_CMD` (`0x0B`) | `00 2B 00` | No payload defined (enum only) |
| `PC_FCU_CMD` (`0x0C`) | `00 2C 00` | No payload defined (enum only) |
| `PC_SETVALUE_CMD` (`0x0D`) | `00 2D 00` | No payload defined (enum only) |
| `PC_DEBUG_CMD` (`0x10`) | `00 30 00` | No payload defined (enum only) |
| `PC_DEBUG_CTL1_CMD` (`0x11`) | `00 31 00` | No payload defined (enum only) |
| `PC_DEBUG_CTL2_CMD` (`0x12`) | `00 32 00` | No payload defined (enum only) |
| `PC_DEBUG_CTL3_CMD` (`0x13`) | `00 33 00` | No payload defined (enum only) |
| `PC_ECHO_CMD` (`0x14`) | `00 34 02 AA 55` | Echo payload `AA 55` |
| `PC_IDTABLE_CMD` (`0x15`) | `00 35 00` | No payload defined (enum only) |
| `PC_IO_ERROR_STATUS_CMD` (`0x16`) | `00 36 00` | No payload defined (enum only) |
| `PC_ERROR_STATUS_CMD` (`0x17`) | `00 37 01 04` | Counter index `0x04` |
| `PC_TASK_STATUS_CMD` (`0x18`) | `00 38 01 00` | Task index `0x00` |
| `PC_USBSTATUS_CMD` (`0x19`) | `00 39 00` | No payload defined (enum only) |
| `PC_ID_CONFIRM_NODE` (`0x1A`) | `00 3A 00` | No payload defined (enum only) |
| `PC_ID_CONFIRM` (`0x1B`) | `00 3B 00` | No payload defined (enum only) |
| `PC_ID_REQUEST` (`0x1C`) | `00 3C 00` | No payload defined (enum only) |
| `PC_CONFIG_CMD` (`0x1D`) | `00 3D 00` | No payload defined (enum only) |
| `PC_ENUMERATE_CMD` (`0x1E`) | `00 3E 00` | No payload defined (enum only) |

> **DPYCTL reminder:** In the `PC_DPYCTL_CMD` examples above, the leading `00`
> is the **board ID high byte**, not the controller ID. The controller/action
> byte appears as the first payload byte (`0x20` or `0x21` for controller ID 1).
